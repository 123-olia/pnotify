<script context="module">
  export const position = 'PrependContainer';
  export const defaults = {
    // Let the user swipe the notice away.
    swipeDismiss: true
  };
</script>
<svelte:window on:resize={() => windowInnerWidth = window.innerWidth} />
<script>
  import { onMount, onDestroy } from 'svelte';

  // The PNotify notice.
  export let self = null;

  export let swipeDismiss = defaults.swipeDismiss;

  let origXY = null;
  let diffXY = null;
  let noticeWidthHeight = null;
  let noticeOpacity = null;
  let csspos = 'left';
  let direction = 'X';
  let span = 'Width';
  let windowInnerWidth = window.innerWidth;
  let offs = [];

  $: {
    const stack = self.stack;
    if (stack) {
      if (windowInnerWidth <= 480) {
        if (!('_m_spacing1' in stack)) {
          stack._m_spacing1 = stack.spacing1;
          stack._m_firstpos1 = stack.firstpos1;
          stack._m_spacing2 = stack.spacing2;
          stack._m_firstpos2 = stack.firstpos2;
        }
        stack.spacing1 = 0;
        stack.firstpos1 = 0;
        stack.spacing2 = 0;
        stack.firstpos2 = 0;
      } else {
        if ('_m_spacing1' in stack) {
          stack.spacing1 = stack._m_spacing1;
          delete stack._m_spacing1;
          stack.firstpos1 = stack._m_firstpos1;
          delete stack._m_firstpos1;
          stack.spacing2 = stack._m_spacing2;
          delete stack._m_spacing2;
          stack.firstpos2 = stack._m_firstpos2;
          delete stack._m_firstpos2;
        }
      }
    }
  }

  onMount(() => {
    offs = [
      self.on('touchstart', e => {
        if (!swipeDismiss) {
          return;
        }

        const stack = self.stack;
        if (stack) {
          switch (stack.dir1) {
            case 'up':
            case 'down':
              csspos = 'left';
              direction = 'X';
              span = 'Width';
              break;
            case 'left':
            case 'right':
              csspos = 'top';
              direction = 'Y';
              span = 'Height';
              break;
          }
        }

        origXY = e.touches[0]['screen' + direction];
        noticeWidthHeight = self.refs.elem['scroll' + span];
        noticeOpacity = window.getComputedStyle(self.refs.elem)['opacity'];
        self.refs.container.style[csspos] = 0;
      }),

      self.on('touchmove', e => {
        if (!origXY || !swipeDismiss) {
          return;
        }

        const curXY = e.touches[0]['screen' + direction];

        diffXY = curXY - origXY;
        const opacity = (1 - (Math.abs(diffXY) / noticeWidthHeight)) * noticeOpacity;

        self.refs.elem.style.opacity = opacity;
        self.refs.container.style[csspos] = diffXY + 'px';
      }),

      self.on('touchend', () => {
        if (!origXY || !swipeDismiss) {
          return;
        }

        self.refs.container.classList.add('ui-pnotify-mobile-animate-left');
        if (Math.abs(diffXY) > 40) {
          const goLeft = (diffXY < 0) ? noticeWidthHeight * -2 : noticeWidthHeight * 2;
          self.refs.elem.style.opacity = 0;
          self.refs.container.style[csspos] = goLeft + 'px';
          self.close();
        } else {
          self.refs.elem.style.removeProperty('opacity');
          self.refs.container.style.removeProperty(csspos);
        }
        origXY = null;
        diffXY = null;
        noticeWidthHeight = null;
        noticeOpacity = null;
      }),

      self.on('touchcancel', () => {
        if (!origXY || !swipeDismiss) {
          return;
        }

        self.refs.elem.style.removeProperty('opacity');
        self.refs.container.style.removeProperty(csspos);
        origXY = null;
        diffXY = null;
        noticeWidthHeight = null;
        noticeOpacity = null;
      }),

      self.on('pnotify:afterClose', () => {
        // Remove any styling we added to close it.
        if (!swipeDismiss) {
          return;
        }

        self.refs.elem.style.removeProperty('opacity');
        self.refs.container.style.removeProperty('left');
        self.refs.container.style.removeProperty('top');
      })
    ];
  });

  onDestroy(() => {
    offs.forEach(off => off());
  });
</script>
<style>
  :global([ui-pnotify] .ui-pnotify-container) {
    position: relative;
  }
  :global([ui-pnotify] .ui-pnotify-mobile-animate-left) {
    transition: left .1s ease;
  }
  :global([ui-pnotify] .ui-pnotify-mobile-animate-top) {
    transition: top .1s ease;
  }
  @media (max-width: 480px) {
    /* -- Notice */
    :global([ui-pnotify].ui-pnotify) {
      font-size: 1.2em;
      -webkit-font-smoothing: antialiased;
      -moz-font-smoothing: antialiased;
      -ms-font-smoothing: antialiased;
      font-smoothing: antialiased;
    }
    :global(body > [ui-pnotify].ui-pnotify) {
      position: fixed;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-down),
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-up) {
      width: 100% !important;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-right),
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-left) {
      height: 100% !important;
    }
    :global([ui-pnotify].ui-pnotify .ui-pnotify-shadow) {
      -webkit-box-shadow: none;
      -moz-box-shadow: none;
      box-shadow: none;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-down .ui-pnotify-shadow) {
      border-bottom-width: 5px;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-up .ui-pnotify-shadow) {
      border-top-width: 5px;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-right .ui-pnotify-shadow) {
      border-right-width: 5px;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-left .ui-pnotify-shadow) {
      border-left-width: 5px;
    }
    :global([ui-pnotify].ui-pnotify .ui-pnotify-container) {
      -webkit-border-radius: 0;
      -moz-border-radius: 0;
      border-radius: 0;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-down .ui-pnotify-container),
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-up .ui-pnotify-container) {
      width: auto !important;
    }
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-right .ui-pnotify-container),
    :global([ui-pnotify].ui-pnotify.ui-pnotify-stack-left .ui-pnotify-container) {
      height: 100% !important;
    }
  }
</style>
