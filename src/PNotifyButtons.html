<script context="module">
  import PNotify from './PNotifyCoreLoader';

  export const key = 'Buttons';

  export const defaults = {
    // Provide a button for the user to manually close the notice.
    closer: true,
    // Only show the closer button on hover.
    closerHover: true,
    // Provide a button for the user to manually stick the notice.
    sticker: true,
    // Only show the sticker button on hover.
    stickerHover: true,
    // The various displayed text, helps facilitating internationalization.
    labels: {
      close: 'Close',
      stick: 'Stick',
      unstick: 'Unstick'
    },
    // The classes to use for button icons. Leave them null to use the classes from the styling you're using.
    classes: {
      closer: null,
      pinUp: null,
      pinDown: null
    }
  };

  // Add button icons to icons objects.
  Object.assign(PNotify.icons.brighttheme, {
    closer: 'brighttheme-icon-closer',
    pinUp: 'brighttheme-icon-sticker',
    pinDown: 'brighttheme-icon-sticker brighttheme-icon-stuck'
  });
  Object.assign(PNotify.icons.bootstrap3, {
    closer: 'glyphicon glyphicon-remove',
    pinUp: 'glyphicon glyphicon-pause',
    pinDown: 'glyphicon glyphicon-play'
  });
  Object.assign(PNotify.icons.fontawesome4, {
    closer: 'fa fa-times',
    pinUp: 'fa fa-pause',
    pinDown: 'fa fa-play'
  });
  Object.assign(PNotify.icons.fontawesome5, {
    closer: 'fas fa-times',
    pinUp: 'fas fa-pause',
    pinDown: 'fas fa-play'
  });
</script>

{#if _showCloser}
  <div
      class="ui-pnotify-closer {(!closerHover || _mouseIsIn) ? '' : 'ui-pnotify-buttons-hidden'}"
      role="button"
      tabindex="0"
      title={labels.close}
      on:click={handleCloserClick}>
    <span class={_closerClass}></span>
  </div>
{/if}
{#if _showSticker}
  <div
      class="ui-pnotify-sticker {(!stickerHover || _mouseIsIn) ? '' : 'ui-pnotify-buttons-hidden'}"
      role="button"
      aria-pressed={_options.hide}
      tabindex="0"
      title={_options.hide ? labels.stick : labels.unstick}
      on:click={handleStickerClick}>
    <span class={_options.hide ? _pinUpClass : _pinDownClass}></span>
  </div>
{/if}

<script>
  import { onMount, tick, createEventDispatcher } from 'svelte';

  const dispatch = createEventDispatcher();

  // The PNotify notice.
  export let _notice = null;
  // The props for the notice.
  export let _options = {};

  export let closer = defaults.closer;
  export let closerHover = defaults.closerHover;
  export let sticker = defaults.sticker;
  export let stickerHover = defaults.stickerHover;
  export let labels = defaults.labels;
  export let classes = defaults.classes;

  let _mouseIsIn = false;
  let _updatingIcon = false;

  // Whether to show the sticker icon.
  $: _showSticker = sticker && !(_notice && _notice.refs.elem.classList.contains('nonblock'));
  // Whether to show the closer icon.
  $: _showCloser = closer && !(_notice && _notice.refs.elem.classList.contains('nonblock'));
  // These are button icon classes.
  $: _pinUpClass = _notice ? (classes.pinUp === null ? _notice.getIcons().pinUp : classes.pinUp) : '';
  $: _pinDownClass = _notice ? (classes.pinDown === null ? _notice.getIcons().pinDown : classes.pinDown) : '';
  $: _closerClass = _notice ? (classes.closer === null ? _notice.getIcons().closer : classes.closer) : '';

  $: async () => {
    if (_updatingIcon) {
      return;
    }

    if (!sticker) {
      return;
    }

    // Font Awesome 5 replaces our lovely element with a gross SVG. In
    // order to make it play nice with Svelte, we have to clear the
    // element and make it again.
    const icon = _options.hide ? classes.pinUp : classes.pinDown;
    if (
      (_options.icons === 'fontawesome5') ||
      (typeof icon === 'string' && icon.match(/(^| )fa[srlb]($| )/))
    ) {
      sticker = false;
      _updatingIcon = true;
      await tick();
      sticker = true;
      _updatingIcon = false;
    }
  };

  onMount(() => {
    dispatch('init', {
      key,
      init
    });
  });

  export function init () {
    _notice.on('mouseenter', () => _mouseIsIn = true);
    _notice.on('mouseleave', () => _mouseIsIn = false);
  }

  function handleStickerClick () {
    _notice.update({ hide: !_options.hide });
  }

  function handleCloserClick () {
    _notice.close(false);
    _mouseIsIn = false;
  }
</script>

<style>
  .ui-pnotify-closer,
  .ui-pnotify-sticker {
    float: right;
    margin-left: .5em;
    cursor: pointer;
  }
  :global([dir=rtl]) .ui-pnotify-closer,
  :global([dir=rtl]) .ui-pnotify-sticker {
    float: left;
    margin-right: .5em;
    margin-left: 0;
  }
  .ui-pnotify-buttons-hidden {
    visibility: hidden;
  }
</style>
