<script context="module">
  import { icons } from './PNotifyCore';

  export const key = 'Buttons';
  export const positition = 'PrependContainer';
  export const defaults = {
    // Provide a button for the user to manually close the notice.
    closer: true,
    // Only show the closer button on hover.
    closerHover: true,
    // Provide a button for the user to manually stick the notice.
    sticker: true,
    // Only show the sticker button on hover.
    stickerHover: true,
    // The various displayed text, helps facilitating internationalization.
    labels: {
      close: 'Close',
      stick: 'Stick',
      unstick: 'Unstick'
    },
    // The classes to use for button icons. Leave them null to use the classes from the styling you're using.
    classes: {
      closer: null,
      sticker: null,
      stuck: null,
      unstuck: null
    }
  };

  // Add button icons to icons objects.
  Object.assign(icons.bootstrap3, {
    closer: 'glyphicon glyphicon-remove',
    sticker: 'glyphicon',
    stuck: 'glyphicon-play',
    unstuck: 'glyphicon-pause'
  });
  Object.assign(icons.fontawesome4, {
    closer: 'fa fa-times',
    sticker: 'fa',
    stuck: 'fa-play',
    unstuck: 'fa-pause'
  });
  Object.assign(icons.fontawesome5, {
    closer: 'fas fa-times',
    sticker: 'fas',
    stuck: 'fa-play',
    unstuck: 'fa-pause'
  });
</script>

{#if closer && !nonBlock}
  <div
      class="ui-pnotify-closer {self.getStyle('closer')} {(!closerHover || mouseIsIn) ? '' : 'ui-pnotify-buttons-hidden'}"
      role="button"
      tabindex="0"
      title={labels.close}
      on:click={() => self.close(false)}>
    <span class={closerClass}></span>
  </div>
{/if}
{#if sticker && !nonBlock}
  <div
      class="ui-pnotify-sticker {self.getStyle('sticker')} {(!stickerHover || mouseIsIn) ? '' : 'ui-pnotify-buttons-hidden'}"
      role="button"
      aria-pressed={!self.hide}
      tabindex="0"
      title={self.hide ? labels.stick : labels.unstick}
      on:click={() => self.hide = !self.hide}>
    <span class="{stickerClass} {self.hide ? unstuckClass : stuckClass}"></span>
  </div>
{/if}

<script>
  import { onDestroy, beforeUpdate, tick } from 'svelte';

  // The PNotify notice.
  export let self = null;

  export let closer = defaults.closer;
  export let closerHover = defaults.closerHover;
  export let sticker = defaults.sticker;
  export let stickerHover = defaults.stickerHover;
  export let labels = defaults.labels;
  export let classes = defaults.classes;

  let mouseIsIn = false;

  // This keeps the beforeUpdate handler from going into a loop when we're taming Font Awesome's magic.
  let updatingIcon = false;
  // Save the old value of hide and icon, so we can do our magic.
  let oldIcon;
  // Whether the notice is in a modal state.
  let modal = false;

  // These are button icon classes.
  $: stickerClass = classes.sticker === null ? self.getIcon('sticker') : classes.sticker;
  $: stuckClass = classes.stuck === null ? self.getIcon('stuck') : classes.stuck;
  $: unstuckClass = classes.unstuck === null ? self.getIcon('unstuck') : classes.unstuck;
  $: closerClass = classes.closer === null ? self.getIcon('closer') : classes.closer;
  $: nonBlock = self.addClass.match(/\bnonblock\b/) || (self.addModalClass.match(/\bnonblock\b/) && modal) || (self.addModelessClass.match(/\bnonblock\b/) && !modal);

  beforeUpdate(async () => {
    if (updatingIcon) {
      return;
    }

    // Font Awesome 5 uses dark magic by replacing the icon element with an SVG.
    // In order to make it play nice with Svelte, we have to clear the element
    // and make it again.
    const icon = self.hide ? unstuckClass : stuckClass;
    if (
      icon !== oldIcon &&
      (
        (self.icons === 'fontawesome5') ||
        (typeof stickerClass === 'string' && stickerClass.match(/(^| )fa[srlb]($| )/)) ||
        (typeof icon === 'string' && icon.match(/(^| )fa[srlb]($| )/))
      )
    ) {
      sticker = false;
      updatingIcon = true;
      await tick();
      sticker = true;
      updatingIcon = false;
      oldIcon = icon;
    }
  });

  let removeMouseEnterHandler = self.on('mouseenter', () => mouseIsIn = true);
  let removeMouseLeaveHandler = self.on('mouseleave', () => mouseIsIn = false);
  let removeEnterModalHandler = self.on('pnotify:enterModal', () => modal = true);
  let removeLeavModalHandler = self.on('pnotify:leaveModal', () => modal = false);
  let removeAfterCloseHandler = self.on('pnotify:afterClose', () => mouseIsIn = false);

  onDestroy(() => {
    removeMouseEnterHandler && removeMouseEnterHandler();
    removeMouseLeaveHandler && removeMouseLeaveHandler();
    removeEnterModalHandler && removeEnterModalHandler();
    removeLeavModalHandler && removeLeavModalHandler();
    removeAfterCloseHandler && removeAfterCloseHandler();
  });
</script>

<style>
  :global(.ui-pnotify-closer),
  :global(.ui-pnotify-sticker) {
    float: right;
    margin-left: .5em;
    cursor: pointer;
  }
  :global([dir=rtl] .ui-pnotify-closer),
  :global([dir=rtl] .ui-pnotify-sticker) {
    float: left;
    margin-right: .5em;
    margin-left: 0;
  }
  :global(.ui-pnotify-buttons-hidden) {
    visibility: hidden;
  }
</style>
