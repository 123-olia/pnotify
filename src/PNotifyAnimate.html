<script context="module">
  import PNotify from './PNotifyCoreLoader';

  export const key = 'Animate';

  export const defaults = {
    // Use animate.css to animate the notice.
    animate: false,
    // The class to use to animate the notice in.
    inClass: '',
    // The class to use to animate the notice out.
    outClass: ''
  };
</script>
<script>
  // The PNotify notice.
  export let _notice = null;
  // The options for the notice.
  export let _options = {};

  export let animate = defaults.animate;
  export let inClass = defaults.inClass;
  export let outClass = defaults.outClass;

  let _animateIn;
  let _animateOut;

  $: {
    if (animate) {
      _notice.$set({ 'animation': 'none' });
      if (!_animateIn) {
        _animateIn = _notice.animateIn;
      }
      if (!_animateOut) {
        _animateOut = _notice.animateOut;
      }
      _notice.$set({
        animateIn,
        animateOut
      });
    } else if (_animateIn && _animateOut) {
      _notice.$set({
        animateIn: _animateIn,
        animateOut: _animateOut
      });
      _animateIn = null;
      _animateOut = null;
    }
  }

  $: {
    if (animate && _notice.refs.elem) {
      var animSpeed = 250;
      if (_options.animateSpeed === 'slow') {
        animSpeed = 400;
      } else if (_options.animateSpeed === 'fast') {
        animSpeed = 100;
      } else if (_options.animateSpeed > 0) {
        animSpeed = _options.animateSpeed;
      }
      animSpeed = animSpeed / 1000;
      _notice.refs.elem.style.WebkitAnimationDuration = animSpeed + 's';
      _notice.refs.elem.style.MozAnimationDuration = animSpeed + 's';
      _notice.refs.elem.style.animationDuration = animSpeed + 's';
    }
  }

  function animateIn (callback) {
    // Declare that the notice is animating in.
    _notice.setAnimating('in');

    const finished = event => {
      if (event && _notice.refs.elem && event.target !== _notice.refs.elem) {
        return;
      }
      if (_notice.refs.elem) {
        _notice.refs.elem.removeEventListener('webkitAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('mozAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('MSAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('oanimationend', finished);
        _notice.refs.elem.removeEventListener('animationend', finished);
      }
      _notice.setAnimatingClass('ui-pnotify-in animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      _notice.setAnimating(false);
    };

    if (_notice.refs.elem) {
      _notice.refs.elem.addEventListener('webkitAnimationEnd', finished);
      _notice.refs.elem.addEventListener('mozAnimationEnd', finished);
      _notice.refs.elem.addEventListener('MSAnimationEnd', finished);
      _notice.refs.elem.addEventListener('oanimationend', finished);
      _notice.refs.elem.addEventListener('animationend', finished);
    }
    _notice.setAnimatingClass('ui-pnotify-in animated ' + inClass);
  }

  function animateOut (callback) {
    // Declare that the notice is animating out.
    _notice.setAnimating('out');

    const finished = event => {
      if (event && _notice.refs.elem && event.target !== _notice.refs.elem) {
        return;
      }
      if (_notice.refs.elem) {
        _notice.refs.elem.removeEventListener('webkitAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('mozAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('MSAnimationEnd', finished);
        _notice.refs.elem.removeEventListener('oanimationend', finished);
        _notice.refs.elem.removeEventListener('animationend', finished);
      }
      _notice.setAnimatingClass('animated');
      if (callback) {
        callback.call();
      }
      // Declare that the notice has completed animating.
      if (_notice.setAnimating) {
        _notice.setAnimating(false);
      }
    };

    if (_notice.refs.elem) {
      _notice.refs.elem.addEventListener('webkitAnimationEnd', finished);
      _notice.refs.elem.addEventListener('mozAnimationEnd', finished);
      _notice.refs.elem.addEventListener('MSAnimationEnd', finished);
      _notice.refs.elem.addEventListener('oanimationend', finished);
      _notice.refs.elem.addEventListener('animationend', finished);
    }
    _notice.setAnimatingClass('ui-pnotify-in animated ' + outClass);
  }
</script>
